# 第2章 Ansible入门

## 安装Ansible

### 管理端安装

#### 1.安装 Ansible 软件

```shell
yum install epel-release
yum install ansible -y
```

#### 2.配置 Ansible 管理节点和主机的连接

```shell
ssh-keygen
ssh-copy-id remoteuser@remoteserver
ssh-keygen remote_servers >> ~/.ssh/known_hosts
```

验证 SSH 配置

```shell
$ ssh remoteuser@remoteserver
# 不提示输入密码，不提醒存储密钥，视为成功
```

- 被管理的主机：须启动 SSH 服务，且 Python 版本 大于 2.4 以上。

## Ansible管理哪些主机

### 主机目录

主机目录（Host Inventory，又称主机清单）是**配置文件**，用来告诉 Ansible 需要管理哪些主机，按需分类主机。

### 主机目录配置文件

默认的文件是：**`/etc/ansible/hosts`**

#### 简单Hosts文件

```shell
192.168.1.50
aserver.foo.org
bserver.foo.org
```

#### 带分组Hosts文件

```shell {1,5}
[web]
web1.foo.com
web2.foo.com

[db]
db1.my.com
db2.my.com
```

## Ansible命令

### 检查 Ansible 安装环境

```shell
# 检查所有主机是否有“bruce”用户，可被访问
$ ansible all -m ping -u bruce
```

### 执行命令

```shell
# 向所有远程主机执行“echo hello”
$ ansible all -a "/bin/echo hello"
```

### 复制文件

```shell
# 复制文件/etc/hosts到远程主机（组）“web”，到/tmp/hosts
$ ansible web -m copy -a "src=/etc/hosts dest=/tmp/hosts"
```

### 安装包

```shell
# 指定web组安装yum包
$ ansible web -m yum -a "name=acme state=present"
```

### 添加用户

```shell
ansible all -m user -a "name=foo password=xxx"
```

### 下载 Git 仓库

```shell
ansible web -m git -a "repo=git://manage.foo.org/api.git dest=/data/api version=HEAD"
```

### 启动服务

```shell
ansible web -m service -a "name=httpd state=started"
```

### 并行执行

```shell
# 启动 10 个并行执行重启
$ ansible lb -a "/sbin/reboot" -f 10
```

### 查看远程主机的全部系统信息

```shell
ansible all -m setup
```

## Ansible用脚本管理主机

Ansible 提供了**脚本**功能。脚本名字为：`Playbook` ，使用 `YAML` 格式，文件以 **`yml`** 或 **`yaml`** 为后缀。

### 执行脚本Playbook

```shell
ansible-playbook deploy.yml
```

### Playbook的例子

Playbook包含了几个关键字，如下：

- **hosts**：某主机的IP，或者主机组名，或者关键字all
- **remote_user**：以某个用户身份执行
- **vars**：变量
- **tasks**：Playbook 的核心，定义顺序执行的动作 Action。每个 Action 调用一个 Ansible 模块。

1. action语法：

```
module: module_parameter=module_value
```

2. 常用模块有 `yum` 、 `copy` 、 `template`等，模块在 Ansible 中的作用，相当于 bash 脚本中的 `yum`、`copy`这样的命令。

- **handers**：Playbook 的 Event 处理操作，有且仅有在被 Action 触发时才会执行。多次触发只执行一次，并按声明顺序执行。

举例：为主机（组） Web 部署 Apache 的 deploy.yml 文件，部署步骤如下：

- 安装 Apache 包
- 复制配置文件 httpd，并保证复制文件后，Apache 服务会被重启
- 复制默认的网页文件 index.html
- 启动 Apache 服务

```yaml
---
hosts: web
vars:
  http_port: 80
  max_clients: 200
remote_user: root
tasks:
  - name: ensure apache is at the lastest version
    yum: pkg=httpd state=latest
  - name: Write the configuration file
    template: src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf
    notify:
      - restart apache
  - name: Write the default index.html file
    template: src=templates/index.html.j2 dest=/var/www/html/index.html
  - name: ensure apache is running
    service: name=httpd state=started
```

当然，也支持 `yaml` 转 `json` 格式，如下所示：

```json
{
    "hosts": "web",
    "vars": {
        "http_port": 80,
        "max_clients": 200
    },
    "remote_user": "root",
    "tasks": [
        {
            "name": "ensure apache is at the lastest version",
            "yum": "pkg=httpd state=latest"
        },
        {
            "name": "Write the configuration file",
            "template": "src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf",
            "notify": [
                "restart apache"
            ]
        },
        {
            "name": "Write the default index.html file",
            "template": "src=templates/index.html.j2 dest=/var/www/html/index.html"
        },
        {
            "name": "ensure apache is running",
            "service": "name=httpd state=started"
        }
    ]
}
```

提供 JSON 和 YAML 互转的在线网站为： <http://www.json2yaml.com/> 。

### Ansible 模块

模块就是 Ansible 的“命令”。模块是 Ansible 命令行和脚本中都需要调用的。

常见的 Ansible 模块有：`yum`、`copy`、`template`等。

查看模块相关帮助：`ansible-doc <module_name>`
